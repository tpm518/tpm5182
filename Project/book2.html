<!DOCTYPE html>
<head>
  <title>Sentiment Analysis by Book</title>
  <meta charset="utf-8">
  <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
  <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
  <script type="text/javascript" src= "../lib/d3-legend.min.js"></script>
  <script type="text/javascript" src= "../lib/d3-geo-projection.v2.min.js"></script>
  <script type="text/javascript" src= "../lib/d3-tip.min.js"></script>
  <script type="text/javascript" src= "../lib/topojson.v2.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">


  <style>

.legend {
  display: table;
  margin: 0 auto;
  font-family: "Helvetica Neue", sans-serif;
  font-size: 12px;
  height: 90px;
  width: 250px;
}
p {
    margin-top: 3px;
  margin-bottom: 3px; /* between paragraphs */
  font-family: "Google Sans", "Open Sans", Arial, Helvetica, sans-serif;
  }


  .d3-tip {
    line-height: 1.5;
    font-weight: 400;
    font-family:"avenir next", Arial, sans-serif;
    padding: 6px;
    background: rgba(0, 0, 0, 0.6);
    color: #3cff00;
    border-radius: 1px;
    pointer-events: none;
  }

  .dropdowns, text , li, label, b{
    font-family: "Google Sans", "Open Sans", Arial, Helvetica, sans-serif;
}
  </style>
</head>

<body>

	<head>
        <br>
        <b style="font-size:20px">Sentiment Analysis by Book</b>
      </head>
      <br>
      <br>
    <!-- Dropdown -->
    <label for="dropdowns">Choose a book:</label>
    <select id="dropdowns">
        <option value=""></option>
        
    </select>
    <br>
    <br>
    <!-- <img id="coverImage" alt="Harry Potter and the Sorcerer's Stone (Harry Potter, #1)" src="https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1474154022l/3._SY475_.jpg"> -->
   <div id="bookinfo">
    <p style="float: left; clear: left" padding: "10px" border:"10px"><img id="coverImage" src=""  padding: "10px" border="10px"></p>

    <p id = "Title" margin="2px">  </p>
    <p id = "Author" border="2px"> </p>
    <p id = "ISBN13" border="2px"> </p>
    <p id = "PublishedDate" border="2px"> </p>
    <p id = "NumPages" border="2px"> </p>
    <p id = "AvgRtg" border="2px"> </p>
    
    <p  border="2px"><a id = "BuyLink" href=""></a></p>
    <p id = "Price" border="2px"> </p>
    <p id = "Currency" border="2px"> </p>

    <br>
    <br>
    <br>
    <br>
    <p id = "Description" border="2px"></p>
    
    </div>
    <!-- append visualization svg to this div-->
    
    <div id="container">
        <div id ='leftrowlist'>   </div>
    <div class="row content">
    
        <div class="col-lg-7 text-left" id ='leftrow'>   </div>
        <div class="col-sm-12 col-md-12 col-lg-4 sidenav" id ='rightrow'></div>

    </div> </div>
<div class = "row">
    <div class="col-sm-6 col-lg-6"></div>
    <p id = "TopEmotion"></p>
    <ol id = "TopEmotionlist">

      </ol>
    <div class="col-sm-6 col-lg-6"></div>
    <p id = "SimilarBooks"></p>
    <ol id = "SimilarBookslist">

      </ol>
  
<!--  -->


</div>


<script>
    var svgWidth = 650;
    var svgHeight = 400;
    
    var chartMargin = {
    top: 30,
    right: 30,
    bottom: 30,
    left: 30
    };

    const tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-10, 0])
                .html(function(d,i) {
          return (`<strong>Chunk: ${i+1}<strong><br>Value: ${d}`);});      
             //  
   
    var colorScale = d3.schemeCategory10;
    // create scales x & y for X and Y axis and set their ranges
    var yLinearScale = d3.scaleLinear()
      .range([350, 25]);

    var XLinearScale = d3.scaleLinear()
      .range([100, 600]);
     


    var svglist = d3
    .select("#leftrowlist")
    .append("svg")
    .attr("height", 110)
    .attr("width", 1000)
    .append("g")
    .attr("transform", "translate(" + chartMargin.left + "," + chartMargin.top + ")")
    .attr("class", "svg");

    var svg = d3
    .select("#leftrow")
    .append("svg")
    .attr("height", 450)
    .attr("width", 770)
    .append("g")
    .attr('preserveAspectRatio',"xMinYMid")
    .attr("transform", "translate(" + chartMargin.left + "," + chartMargin.top + ")")
    .attr("class", "svg");

    var svg2 = d3
    .select("#rightrow")
    .append("svg")
    .attr("height", 450)
    .attr("width", 1000)
    .attr('preserveAspectRatio',"xMaxYMid")
    .append("g")
    .attr("transform", "translate(" + chartMargin.left + "," + chartMargin.top + ")")
    .attr("class", "svg");

    svg.call(tip);
    svg2.call(tip);
    XLinearScale.domain([0,20]);
   // yLinearScale.domain([0, .3]);


    // Get the data
	var pathToCsv = "testschemawithisbn.csv";		// path to csv


    function creategraph(data, selectedbook, allemotions, elem){ 
        d3.selectAll("path.line").remove();
        d3.selectAll("text").remove();
        d3.selectAll("circle").remove();
        d3.selectAll("#leftaxis").remove();
        d3.selectAll("#bottomaxis").remove();
        d3.selectAll("li").remove();
        // Title	Author	PublishedDate	NumPages	AvgRtg	Description	BuyLink	Price	Currency
     
       
        var mydata = data.filter(function(d) { return d.Title == selectedbook; });
        console.log(mydata)
        var apidata = mydata[0];
        var isbn = apidata["ISBN13"].split("'");
        isbn = isbn[isbn.length-2];

        d3.select("#Title").text(" Title: " + apidata["Title"]);
        d3.select("#Author").text(" Author: " + apidata["Author"]);
        d3.select("#ISBN13").text(" ISBN: " + isbn);
        if(apidata["PublishedDate"] != ""){d3.select("#PublishedDate").text(" Published Date: " + apidata["PublishedDate"]);}
            else{d3.select("#PublishedDate").text("");};
        if(apidata["NumPages"] != ""){d3.select("#NumPages").text(" Number of Pages: " + apidata["NumPages"])}
             else{d3.select("#NumPages").text("");};
        if(apidata["AvgRtg"] != ""){d3.select("#AvgRtg").text(" Rating: " + apidata["AvgRtg"]);}
            else{d3.select("#AvgRtg").text("");};
        if(apidata["Description"] != ""){d3.select("#Description").text(" Description: " + apidata["Description"]);}
            else{d3.select("#Description").text("");};
        if(apidata["BuyLink"] != ""){d3.select("#BuyLink").text(" Click here to buy");
        d3.select("#BuyLink").on("click", function() { window.open(apidata["BuyLink"]); });}
             else{d3.select("#BuyLink").text("");};
        
        if(apidata["Price"] != ""){d3.select("#Price").text(" Price: " + apidata["Price"] + " " + apidata["Currency"]);}
        else{d3.select("#Price").text("");};


        d3.select("#TopEmotion").text("Top Emotions:");
        d3.select("#SimilarBooks").text( "Most Similar Books:");



        d3.select("#TopEmotionlist")
      .selectAll('myOptions')
     	.data([apidata["TopEmotion1"], apidata["TopEmotion2"], apidata["TopEmotion3"]])
      .enter()
    	.append('li')
      .text(function (d) { return d; }) // text showed in the menu
      .attr("value", function (d) { return d; });


      d3.select("#SimilarBookslist")
      .selectAll('myOptions')
     	.data([apidata["Similar1"], apidata["Similar2"], apidata["Similar3"]])
        .enter()
    	.append('li')
        .attr("id", function (d) { return data.filter(function(dd) { return dd.book == d; })[0]['Title']; })
      .text(function (d) { return data.filter(function(dd) { return dd.book == d; })[0]['Title']; }) // text showed in the menu
      .attr("value", function (d) { return d; });

    svglist.append("text")      // text label for the x axis
                    .attr("x", 100 )
                    .attr("y",  10 )
                    .style("text-anchor", "middle")
                    .text("TOP EMOTIONS");
    svglist.append("text")      // text label for the x axis
                    .attr("x", 500 )
                    .attr("y",  10 )
                    .style("text-anchor", "middle")
                    .text("SIMILAR BOOKS");
    var topemotionlist = [apidata["TopEmotion1"], apidata["TopEmotion2"], apidata["TopEmotion3"]];
    var similarbooklist = [apidata["Similar1"], apidata["Similar2"], apidata["Similar3"]];
    var listspacing = 0;
    topemotionlist.forEach(function(topemotion){
        svglist.append("text")      // text label for the x axis
                    .attr("x", 100 )
                    .attr("y",  listspacing*20+30 )
                    .style("text-anchor", "middle")
                    .text(topemotion);
                    listspacing = listspacing +1;
    });

    var listspacing = 0;
    similarbooklist.forEach(function(simbook){
        svglist.append("text")      // text label for the x axis
                    .attr("x", 500 )
                    .attr("y",  listspacing*20+30 )
                    .style("text-anchor", "middle")
                    .text(  data.filter(function(dd) { return dd.book == simbook; })[0]['Title'].slice(0,40))


        svglist.append("text")      // text label for the x axis
                    .attr("x", 700 )
                    .attr("y",  listspacing*20+30 )
                   .attr("id", data.filter(function(dd) { return dd.book == simbook; })[0]['Title']+"Compare")
                    .style("text-anchor", "middle")
                    .attr("text-decoration", "underline")
                    .style("stroke", "blue")
                    .text(  "Compare")
                    .on('mouseover',function(d,i){

                            d3.select(this)
                            .style("stroke", "red");})
                    .on('mouseout',function(d,i){

                                d3.select(this)
                                .style("stroke", "blue");})
                    .on('click',function(d,i){

                                d3.select(this)
                                .style("color", "blue");

                                    createsvggraph(data, this["id"].slice(0,-7), allemotions, svg2);})


        svglist.append("text")      // text label for the x axis
                    .attr("x", 800 )
                    .attr("y",  listspacing*20+30 )
                    .attr("id", data.filter(function(dd) { return dd.book == simbook; })[0]['Title']+"Open")
                    .style("text-anchor", "middle")
                    .attr("text-decoration", "underline")
                    .style("stroke", "blue")
                    .text("Open")
                    .on('mouseover',function(d,i){

                            d3.select(this)
                            .style("stroke", "red");})
                    .on('mouseout',function(d,i){

                        d3.select(this)
                        .style("stroke", "blue");})
                    .on('click',function(d,i){

                        d3.select(this)
                        .style("color", "blue");

                    creategraph(data, this["id"].slice(0,-4), allemotions, svg);
                    var dd=document.getElementById("dropdowns")
        var aryOptions=dd.getElementsByTagName('option');
        var cpt=0;
        var indexValue=false;
        for(cpt=0;cpt<aryOptions.length;cpt++){
        if(aryOptions[cpt].textContent==this["id"].slice(0,-4)){
            indexValue=cpt;
        }
        };
        dd.selectedIndex=indexValue;

})


                    listspacing = listspacing +1;
    });




      d3.select("#SimilarBookslist")
      .selectAll('li')
      .on('mouseover',function(d,i){

        d3.select(this)
        .style("color", "red");})
        .on('mouseout',function(d,i){

        d3.select(this)
        .style("color", "black");})
        .on('click',function(d,i){

        d3.select(this)
        .style("color", "blue");
        
        var mydata2 = data.filter(function(d) { return d.Title == this["id"]; });

        createsvggraph(data, this["id"], allemotions, svg2);


        } );


        document.getElementById("coverImage").src = apidata["ImgURL"];

        createsvggraph(data, selectedbook, allemotions, elem);


   }


   function createsvggraph(data, selectedbook, allemotions, elem){ 
        elem.selectAll("path.line").remove();
        elem.selectAll("text").remove();
        elem.selectAll("circle").remove();
        elem.selectAll("#leftaxis").remove();
        elem.selectAll("#bottomaxis").remove();
    var mydata = data.filter(function(d) { return d.Title == selectedbook; });

        var apidata = mydata[0];
    mycolor = 0;
        var ylegend = 40;
        var maxylegend = 0;
        allemotions.forEach(function(myemotion){
            if ((d3.extent(mydata, d => d[myemotion])[1])>maxylegend){
                maxylegend = d3.extent(mydata, d => d[myemotion])[1]
            };
        });

        yLinearScale.domain([0,maxylegend+.03]);

        allemotions.forEach(function(myemotion){
          
            emotion = mydata.map(value => value[myemotion]);
            chunk = mydata.map(value => value.chunk);

            var lineFunc = d3.line()
            .x(function(d, index) {
            return XLinearScale(index+1);
            })
            .y(function(d) {
            return yLinearScale(d);
            });


            elem.append("path")
            .data(emotion)
            .attr("class", "line")
            .attr("fill", "none")
            .attr("id", myemotion)
            .style("stroke", colorScale[mycolor])
            .style('stroke-width', '1px')
            .attr('d', lineFunc(emotion));

            
            elem.selectAll("dot")
            .data(emotion)
            .enter().append("circle")
            .attr("r", 4)
            .attr("fill", colorScale[mycolor])
            .attr("cx", XLinearScale(20) + 40)
            .attr("cy", ylegend)
            .style('opacity', 0.7)
            .style('stroke-width', 0.3);

            elem.append("text")      
            .attr("x", XLinearScale(20) + 55)
            .attr("y", ylegend) 
            .attr("id", myemotion+"legend")
            .style("stroke", colorScale[mycolor])
            .style("text-anchor", "left")
            .style("alignment-baseline", "central")
            .text(myemotion)
            .on('mouseover',function(d,i){

                d3.select(this)
                .style('opacity', 1)
                .style("stroke", "black");
              
                
                d3.selectAll("path.line")
                .style("opacity", .2);

                d3.selectAll("circle")
                .style("opacity", .2);

                d3.selectAll("#"+this['id'].slice(0,-6))
                .style("opacity", 1)
                .style('stroke-width', '2px');


                d3.selectAll("#"+this['id'].slice(0,-6)+"dot")
                .style("opacity", 1);
            })
            .on('mouseout', function(d){
                d3.select(this)
                .style('opacity', 1)
                .style("stroke", colorScale[allemotions.indexOf(this['id'].slice(0,-6))]);

                d3.selectAll("path.line")
                .style("opacity", 1)
                .style('stroke-width', '1px');

                d3.selectAll("circle")
                .style("opacity", 1);
            });
           
            ylegend = ylegend + 20;
      
            elem.selectAll("dot")
            .data(emotion)
            .enter().append("circle")
            .attr("r", 4)
            .attr("id", myemotion+"dot")
            .attr("fill", colorScale[mycolor])
            .attr("cx", function(d,i) { return XLinearScale(i+1); })
            .attr("cy", function(d) { return yLinearScale(d); })
            .style('opacity', 0.7)
            .style('stroke-width', 0.3)
            .on('mouseover',function(d,i){
               // mygamedata_country = mygamedata.filter(function(i) { return i.Country == d["properties"]["name"]; });
                
               // if(mygamedata_country.length !=0){
                   tip.show(d,i);
                d3.select(this)
                .style('opacity', 1)
                .attr("r", 7)
                .style('stroke-width', 3);
                
            })
            .on('mouseout', function(d){
               tip.hide(d);
                d3.select(this)
                .style('opacity', 0.7)
                .attr("r", 4)
                .style('stroke-width',0.3);
            });;


            mycolor = mycolor+1;

   })


             elem.append("text")      // text label for the x axis
                    .attr("x", 350 )
                    .attr("y",  400 )
                    .style("text-anchor", "middle")
                    .text("Chunk");
                elem.append("text")      // text label for the y axis
                    .attr("transform", "rotate(-90)")
                    .attr("x", -200 )
                    .attr("y",  15 )
                    .style("text-anchor", "middle")
                    .text("Emotion Fraction");
                elem.append("text")      // text label for the title
                    .attr("x", 350 )
                    .attr("y",  10 )
                    .style("text-anchor", "middle")
                    .text("Sentiment Analysis of "+ "'" + apidata["Title"].slice(0,45) + "'");

            var bottomAxis = d3.axisBottom(XLinearScale);
            var leftAxis = d3.axisLeft(yLinearScale); 
           
            elem.append("g")
            .classed("axis", true)
            .attr("id", "leftaxis")
            .attr("transform", `translate(100, 0)`)
            .call(leftAxis);

            elem.append("g")
				.attr("class", "x axis")
                .attr("id", "bottomaxis")
				.attr("transform", "translate(0," + 350 + ")")
				.call(bottomAxis);

   }

    d3.dsv(",", pathToCsv, function (d) {
      return {

        chunk: parseInt(d["chunk"]),
        anger: parseFloat(d["anger"]),
        anticipation: parseFloat(d["anticipation"]),
        disgust: parseFloat(d["disgust"]),
        fear: parseFloat(d["fear"]),
        joy: parseFloat(d["joy"]),
        negative: parseFloat(d["negative"]),
        positive: parseFloat(d["positive"]),
        sadness: parseFloat(d["sadness"]),
        surprise: parseFloat(d["surprise"]),
        trust: parseFloat(d["trust"]),
        book: d["book"],
        Query: d["Query"],
        Filename: d["Filename"],
        ISBN13: d["ISBN13"],
        Title: d["Title"],
        Author: d["Author"],
        PublishedDate: d["PublishedDate"],
        ImgURL: d["ImgURL"],
        NumPages: d["NumPages"],
        AvgRtg: d["AvgRtg"],
        Description: d["Description"],
        BuyLink: d["BuyLink"],
        Price: d["Price"],
        Currency: d["Currency"],
        TopEmotion1: d["TopEmotion1"],
        TopEmotion2: d["TopEmotion2"],
        TopEmotion3: d["TopEmotion3"],
        Similar1: d["Most Similar"],
        Similar2: d["2nd Most Similar"],
        Similar3: d["3rd Most Similar"]
      }
    }).then(function (data) {
      console.log(data); // you should see the data in your browser's developer tools console 
      var allcolumns = Object.keys(data[0]);
        var allemotions = allcolumns.slice(1,11);
       allemotions.splice(5,1);
       allemotions.splice(5,1);
      console.log(allemotions);
   // add the options to the button
   var distinctbooks = [...new Set(data.map(x=> x.Title))];
   distinctbooks = distinctbooks.sort();
   //selectedbook = data[0]['Title']
   d3.select("#dropdowns")
      .selectAll('myOptions')
     	.data(distinctbooks)
      .enter()
    	.append('option')
      .text(function (d) { return d; }) // text showed in the menu
      .attr("value", function (d) { return d; }) // corresponding value returned by the button

      const Selector = document.getElementById('dropdowns');
      Selector.addEventListener('change', (e) => {  selectedbook = e.target.value; 
        
        creategraph(data, selectedbook, allemotions, svg);});
      


    }).catch(function (error) {
      console.log(error);
    });

</script>

</body>